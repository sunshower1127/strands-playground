# STEP A: ν™κ²½ μ„¤μ • λ° OpenSearch μ—°κ²°

## μƒνƒ: μ™„λ£

## ν•  μΌ
- [x] Python ν”„λ΅μ νΈ μ΄κΈ°ν™” (uv, Python 3.11)
- [x] μμ΅΄μ„± μ„¤μΉ
- [x] OpenSearch ν΄λΌμ΄μ–ΈνΈ κµ¬ν„
- [x] SSH ν„°λ„ μ„¤μ • (VPC μ ‘κ·Ό)
- [x] OpenSearch μ—°κ²° ν…μ¤νΈ μ„±κ³µ

---

## 1. ν”„λ΅μ νΈ μ΄κΈ°ν™”

```bash
uv init --python 3.11
uv add opensearch-py litellm python-dotenv pydantic pandas boto3
uv add --dev ruff pytest
```

## 2. ν™κ²½ λ³€μ

`.env.example` β†’ `.env` λ³µμ‚¬ ν›„ μ„¤μ •:

```env
OPENSEARCH_USERNAME=admin
OPENSEARCH_PASSWORD=your-password
OPENSEARCH_INDEX=your-index
```

## 3. SSH ν„°λ„ (VPC OpenSearch μ ‘κ·Ό)

OpenSearchκ°€ VPC λ‚΄λ¶€μ— μμ–΄ μ§μ ‘ μ ‘κ·Ό λ¶κ°€. Bastion μ„λ²„λ¥Ό ν†µν• SSH ν„°λ„λ§ μ‚¬μ©.

### VPCλ€?

**VPC (Virtual Private Cloud)** λ” AWS ν΄λΌμ°λ“ λ‚΄μ—μ„ λ…Όλ¦¬μ μΌλ΅ κ²©λ¦¬λ κ°€μƒ λ„¤νΈμ›ν¬λ‹¤.
μ‰½κ² λ§ν•΄ ν΄λΌμ°λ“μ—μ„ λ‚λ§μ μ‚¬μ„¤ λ„¤νΈμ›ν¬ κ³µκ°„μ„ λ§λ“λ” κ²ƒ.

### μ™ OpenSearchλ¥Ό VPC μ•μ— λ‘λ”κ°€?

NAT Gateway λΉ„μ© μ κ°μ„ μ„ν•΄μ„λ‹¤.

```
# μ›λ κµ¬μ΅° (λΉ„μ© λ§μ΄ λ“¦)
Lambda β†’ NAT Gateway β†’ μΈν„°λ„· β†’ OpenSearch(Public)
              π’°
           μ—¬κΈ°κ°€ λΉ„μ!

# κ°μ„ λ κµ¬μ΅° (λΉ„μ© μ κ°)
Lambda β†’ VPC Endpoint β†’ OpenSearch(VPC λ‚΄λ¶€)
   μΈν„°λ„· μ• κ±°μΉ¨ β†’ NAT Gateway λ¶ν•„μ” β†’ λΉ„μ© μ κ°
```

- **NAT Gateway**: VPC Private Subnetμ λ¦¬μ†μ¤κ°€ μΈν„°λ„·μ— λ‚κ° λ• κ±°μΉλ” κ΄€λ¬Έ (μ‹κ°„λ‹Ή + λ°μ΄ν„° μ „μ†΅λ‰ κ³ΌκΈ)
- **VPC Endpoint**: VPC λ‚΄λ¶€μ—μ„ AWS μ„λΉ„μ¤μ— μ§μ ‘ μ ‘κ·Όν•λ” ν†µλ΅ (μΈν„°λ„· μ• κ±°μΉ¨)

### VPC μ‚¬μ© ν”ν• μ‹λ‚λ¦¬μ¤

```
μΈν„°λ„·
   β†“
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚ VPC                                     β”‚
β”‚  β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”    β”‚
β”‚  β”‚ Public Subnet                   β”‚    β”‚
β”‚  β”‚   ALB (λ΅λ“λ°Έλ°μ„)               β”‚    β”‚
β”‚  β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”¬β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”    β”‚
β”‚                 β†“                       β”‚
β”‚  β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”    β”‚
β”‚  β”‚ Private Subnet                  β”‚    β”‚
β”‚  β”‚   ECS/EC2 (μ•± μ„λ²„)              β”‚    β”‚
β”‚  β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”¬β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”    β”‚
β”‚                 β†“                       β”‚
β”‚  β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”    β”‚
β”‚  β”‚ Private Subnet                  β”‚    β”‚
β”‚  β”‚   RDS (λ°μ΄ν„°λ² μ΄μ¤)             β”‚    β”‚
β”‚  β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”    β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
```

| κ³„μΈµ | μ„μΉ | μμ‹ |
|------|------|------|
| μ™Έλ¶€ λ…Έμ¶ | Public Subnet | ALB, API Gateway, Bastion |
| λΉ„μ¦λ‹μ¤ λ΅μ§ | Private Subnet | ECS, Lambda, EC2 |
| λ°μ΄ν„° | Private Subnet | RDS, Redis, OpenSearch |

**ν•µμ‹¬**: μ™Έλ¶€μ—λ” μ…κµ¬λ§ μ—΄μ–΄λ‘κ³ , μ¤‘μ”ν• κ±΄ μ „λ¶€ Privateμ— μ¨κΈ°λ” κµ¬μ΅°.

### VPC λ‚΄ λ¦¬μ†μ¤ κ°„ ν†µμ‹ 

κ°™μ€ VPC μ•μ— λ‘λ” κ² κµ­λ£°μ΄λ‹¤.

| ν•­λ© | κ°™μ€ VPC λ‚΄λ¶€ | μΈν„°λ„· κ²½μ  |
|------|---------------|-------------|
| λΉ„μ© | λ¬΄λ£ (κ°™μ€ AZ) / μ €λ ΄ (λ‹¤λ¥Έ AZ) | NAT Gateway λΉ„μ© λ°μƒ |
| μ†λ„ | λΉ λ¦„ (λ‚΄λ¶€ λ„¤νΈμ›ν¬) | λλ¦Ό (μΈν„°λ„· μ™•λ³µ) |
| λ³΄μ• | Private IPλ΅ ν†µμ‹ , μ™Έλ¶€ λ…Έμ¶ μ—†μ | νΌλΈ”λ¦­ λ…Έμ¶ ν•„μ” |
| μ„¤μ • | Security Groupλ§ μ—΄λ©΄ λ¨ | λ°©ν™”λ²½, μΈμ¦ λ“± λ³µμ΅ |

μ½”λ“μƒμ—μ„λ” κ·Έλƒ¥ Private IPλ‚ DNSλ΅ νΈμ¶ν•λ©΄ λλ‹¤:

```python
import requests

# EC2μ Private IPλ΅ νΈμ¶
response = requests.get("http://10.0.1.10:8080/api/users")

# λλ” λ‚΄λ¶€ DNS μ‚¬μ©
response = requests.get("http://my-service.internal:8080/api/users")
```

VPC μ„¤μ •μ€ μΈν”„λΌ λ λ²¨μ΄κ³ , μ½”λ“μ—μ„λ” λ„¤νΈμ›ν¬κ°€ μ—°κ²°λμ–΄ μλ‹¤λ” μ „μ  ν•μ— κ·Έλƒ¥ μ£Όμ†λ΅ νΈμ¶ν•λ” κ²ƒλΏμ΄λ‹¤.

```bash
make tunnel
```

- ν‚¤ νμΌ: `temp-bastion-key.cer` (ν”„λ΅μ νΈ λ£¨νΈ, gitignore μ²λ¦¬λ¨)
- λ΅μ»¬ ν¬νΈ 9443 β†’ μ›κ²© OpenSearch 443

## 4. ν…μ¤νΈ κ²°κ³Ό

```bash
# ν„°λ―Έλ„ 1
make tunnel

# ν„°λ―Έλ„ 2
make os CMD="test"
```

μ„±κ³µ μ¶λ ¥:

```
Connecting to: localhost
β“ Connected! Cluster: xxx, Version: 7.10.2
β“ Indices count: 15
```
